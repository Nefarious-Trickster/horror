<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>The Echo Census - Web Prototype</title>
  <style>
    :root { color-scheme: dark; }
    body {
      margin: 0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: #07090c;
      color: #e6e6e6;
      display: grid;
      place-items: center;
      min-height: 100vh;
    }
    .app {
      width: min(900px, 92vw);
      background: #10141a;
      border: 1px solid #2a313d;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 24px 80px rgba(0,0,0,.55);
    }
    .header {
      padding: 16px 18px;
      border-bottom: 1px solid #2a313d;
      background: linear-gradient(180deg, #161d27 0%, #111722 100%);
    }
    h1 { margin: 0; font-size: 1.1rem; letter-spacing: .03em; }
    .content { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; padding: 14px; }
    .panel { border: 1px solid #2a313d; border-radius: 8px; padding: 12px; background: #0d1117; }
    .meta { display: grid; gap: 6px; font-size: .95rem; }
    .log {
      height: 280px;
      overflow: auto;
      white-space: pre-wrap;
      line-height: 1.35;
      font-size: .92rem;
      background: #080b10;
      border: 1px solid #2a313d;
      border-radius: 6px;
      padding: 10px;
    }
    .actions { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
    button {
      background: #1d2735;
      color: #f0f0f0;
      border: 1px solid #34455c;
      border-radius: 6px;
      padding: 7px 10px;
      cursor: pointer;
    }
    button:hover { background: #253246; }
    ul { margin: 6px 0 0 18px; padding: 0; }
    .footer { padding: 10px 14px; border-top: 1px solid #2a313d; color: #9da9b8; font-size: .86rem; }
    @media (max-width: 760px) { .content { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <main class="app">
    <section class="header">
      <h1>THE ECHO CENSUS â€” Web Prototype</h1>
    </section>
    <section class="content">
      <section class="panel">
        <div class="meta" id="meta"></div>
        <div class="actions" id="actions"></div>
      </section>
      <section class="panel">
        <strong>Inspection Log</strong>
        <div class="log" id="log"></div>
      </section>
    </section>
    <section class="footer">Tip: Repeat habits and the Echo starts predicting you.</section>
  </main>

  <script>
    const FLOOR_GRAPH = {
      "Lobby": ["Hallway A", "Stairwell B"],
      "Hallway A": ["Lobby", "Laundry", "Unit 101"],
      "Laundry": ["Hallway A", "Unit 102"],
      "Unit 101": ["Hallway A", "Unit 102"],
      "Unit 102": ["Laundry", "Unit 101", "Stairwell B"],
      "Stairwell B": ["Lobby", "Unit 102", "Elevator"],
      "Elevator": ["Stairwell B"]
    };

    const DEFAULT_OBJECTIVES = [
      "Inspect Unit 101 meter",
      "Collect wet footprint sample",
      "Submit floor report"
    ];

    const game = {
      room: "Lobby",
      objectives: [...DEFAULT_OBJECTIVES],
      completed: [],
      tension: 0,
      alive: true,
      won: false,
      routeCounts: new Map(),
      hideCounts: new Map(),
      actionCounts: new Map()
    };

    const metaEl = document.getElementById("meta");
    const logEl = document.getElementById("log");
    const actionsEl = document.getElementById("actions");

    function incCount(map, key) {
      map.set(key, (map.get(key) || 0) + 1);
    }

    function learnAction(action) {
      incCount(game.actionCounts, action);
      if (action === "hide") incCount(game.hideCounts, game.room);
    }

    function learnTransition(prevRoom, nextRoom) {
      incCount(game.routeCounts, `${prevRoom}->${nextRoom}`);
    }

    function predictRoom(currentRoom, neighbors) {
      let bestRoom = null;
      let best = 0;
      for (const room of neighbors) {
        const score = game.routeCounts.get(`${currentRoom}->${room}`) || 0;
        if (score > best) {
          best = score;
          bestRoom = room;
        }
      }
      return best === 0 ? null : bestRoom;
    }

    function hauntLine() {
      const hidesHere = game.hideCounts.get(game.room) || 0;
      if (hidesHere >= 2) return "The nearest hiding spot is already open, waiting.";

      let topAction = null;
      let topCount = 0;
      for (const [action, count] of game.actionCounts.entries()) {
        if (count > topCount) {
          topCount = count;
          topAction = action;
        }
      }

      if (topAction === "sprint") return "A breathy imitation of your sprint cadence echoes behind you.";
      if (topAction === "wait") return "Somebody in the next room waits at the exact same tempo as you.";

      const atmospheric = [
        "The compliance tablet vibrates before your hand touches it.",
        "Moist footprints appear beside yours for three steps, then stop.",
        "Your recorded whisper plays from an impossible angle."
      ];
      return atmospheric[Math.floor(Math.random() * atmospheric.length)];
    }

    function resolveEchoEvent(baseText) {
      game.tension += 1;
      const haunt = hauntLine();
      if (game.tension >= 12 && Math.random() < 0.3) {
        game.alive = false;
        return `${baseText} ${haunt} The lights cut out. Something finishes your sentence for you.`;
      }
      return `${baseText} ${haunt}`;
    }

    function completeObjective(text) {
      const idx = game.objectives.indexOf(text);
      if (idx >= 0) {
        game.objectives.splice(idx, 1);
        game.completed.push(text);
      }
    }

    function step(action) {
      if (!game.alive || game.won) return "Run has ended. Refresh to restart.";
      learnAction(action);

      if (action.startsWith("move:")) {
        const destination = action.split(":")[1];
        if (!FLOOR_GRAPH[game.room].includes(destination)) {
          return `You cannot reach ${destination} from ${game.room}.`;
        }

        const prediction = predictRoom(game.room, FLOOR_GRAPH[game.room]);
        const prev = game.room;
        game.room = destination;
        learnTransition(prev, destination);

        let text = `You move to ${destination}.`;
        if (prediction === destination && Math.random() < 0.7) {
          game.tension += 4;
          text += " Your own footsteps arrive one room ahead of you.";
        }

        if (destination === "Elevator" && game.objectives.length === 0) {
          game.won = true;
          return text + " Report submitted. Census cycle interrupted.";
        }

        return resolveEchoEvent(text);
      }

      if (action === "hide") {
        game.tension += 1;
        return resolveEchoEvent("You hide and count your breathing.");
      }

      if (action === "inspect") {
        if (game.room === "Unit 101") {
          completeObjective("Inspect Unit 101 meter");
          return "Meter inspected. Someone already circled your name in red ink.";
        }
        if (game.room === "Laundry") {
          completeObjective("Collect wet footprint sample");
          return "Sample bagged. The footprint depth matches your own weight.";
        }
        if (game.room === "Elevator" && game.objectives.length === 0) {
          completeObjective("Submit floor report");
          game.won = true;
          return "You submit the report. The tablet asks if you consent to profile retention.";
        }
        game.tension += 1;
        return resolveEchoEvent("Nothing useful to inspect here.");
      }

      if (action === "wait") {
        game.tension += 2;
        return resolveEchoEvent("You wait. Pipes answer in the walls.");
      }

      if (action === "sprint") {
        game.tension += 3;
        return resolveEchoEvent("You sprint loudly, teaching the building your panic rhythm.");
      }

      return "Unknown action.";
    }

    function availableActions() {
      const exits = FLOOR_GRAPH[game.room].map((room) => `move:${room}`);
      return [...exits, "hide", "inspect", "wait", "sprint"];
    }

    function render() {
      const objectives = game.objectives.length
        ? `<ul>${game.objectives.map((o) => `<li>${o}</li>`).join("")}</ul>`
        : "<em>None</em>";

      metaEl.innerHTML = `
        <div><strong>Location:</strong> ${game.room}</div>
        <div><strong>Tension:</strong> ${game.tension}</div>
        <div><strong>Status:</strong> ${game.won ? "Escaped" : game.alive ? "Active" : "Consumed"}</div>
        <div><strong>Objectives:</strong>${objectives}</div>
      `;

      actionsEl.innerHTML = "";
      for (const action of availableActions()) {
        const btn = document.createElement("button");
        btn.textContent = action;
        btn.disabled = !game.alive || game.won;
        btn.onclick = () => {
          appendLog(`> ${action}`);
          appendLog(step(action));
          if (game.won) appendLog("Ending: You escaped the floor, but your pattern remains.");
          if (!game.alive) appendLog("Ending: Your Echo completed the inspection in your place.");
          render();
        };
        actionsEl.appendChild(btn);
      }

      const restart = document.createElement("button");
      restart.textContent = "restart";
      restart.onclick = () => location.reload();
      actionsEl.appendChild(restart);
    }

    function appendLog(text) {
      logEl.textContent += (logEl.textContent ? "\n" : "") + text;
      logEl.scrollTop = logEl.scrollHeight;
    }

    appendLog("You are an overnight inspector. Repeat patterns and the Echo adapts.");
    render();
  </script>
</body>
</html>
